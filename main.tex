\documentclass[12pt,a4paper,openany]{book}

% 中文支持
\usepackage[UTF8]{ctex}

% 页面设置
\usepackage[margin=2.5cm]{geometry}
\usepackage{fancyhdr}

% 代码高亮
\usepackage{listings}
\usepackage{xcolor}

% 定义listings需要的颜色
\definecolor{RoyalBlue}{RGB}{65,105,225}
\definecolor{TealBlue}{RGB}{54,117,136}
\definecolor{BrickRed}{RGB}{205,92,92}
\definecolor{Purple}{RGB}{128,0,128}

% 图片支持
\usepackage{graphicx}
\usepackage{float}

% 数学公式
\usepackage{amsmath}
\usepackage{amssymb}

% 表格
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{tikz}
\usetikzlibrary{positioning,calc,fit}

% 列表间距控制
\usepackage{enumitem}
\setlist[itemize]{itemsep=0.5ex,parsep=0pt,topsep=0pt,partopsep=0pt,before={\vspace{-0.2ex}},after={\vspace{-0.5ex}}}
\setlist[enumerate]{itemsep=0.5ex,parsep=0pt,topsep=0pt,partopsep=0pt,before={\vspace{-0.2ex}},after={\vspace{-0.5ex}}}

% 链接支持 - 必须放在最后加载
\usepackage{hyperref}
\usepackage{bookmark}

% 目录深度
\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

% 定义Rust语言支持
\lstdefinelanguage{Rust}{
    keywords={
        as, break, const, continue, crate, else, enum, extern, false, fn,
        for, if, impl, in, let, loop, match, mod, move, mut, pub, ref,
        return, self, Self, static, struct, super, trait, true, type, unsafe,
        use, where, while, async, await, dyn
    },
    keywordstyle=\color{RoyalBlue}\bfseries,
    ndkeywords={
        bool, u8, u16, u32, u64, u128, i8, i16, i32, i64, i128, f32, f64,
        usize, isize, char, str, String, Vec, Option, Result, Box
    },
    ndkeywordstyle=\color{Purple}\bfseries,
    identifierstyle=\color{black},
    sensitive=true,
    comment=[l]{//},
    morecomment=[s]{/*}{*/},
    commentstyle=\color{TealBlue}\ttfamily,
    stringstyle=\color{BrickRed}\ttfamily,
    morestring=[b]"
    % 不使用单引号作为字符串分隔符，避免与Rust生命周期语法冲突
    % morestring=[b]'
}

% 定义一个"纯文本"语言用于命令输出/日志
\lstdefinelanguage{Plain}{sensitive=false}

% listings代码样式设置
\lstset{
    language=Rust,
    basicstyle=\ttfamily\small\color{black},
    keywordstyle=\color{RoyalBlue}\bfseries,
    commentstyle=\color{TealBlue},
    stringstyle=\color{BrickRed},
    numbers=left,
    numberstyle=\tiny\color{gray},
    stepnumber=1,
    numbersep=5pt,
    backgroundcolor=\color{gray!10},
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    frame=single,
    rulecolor=\color{black},
    tabsize=2,
    captionpos=b,
    breaklines=true,
    breakatwhitespace=false,
    escapeinside={\%*}{*)}
}

% 超链接样式
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,
    urlcolor=cyan,
    citecolor=green,
    bookmarksnumbered=true,
    bookmarksopen=true,
    bookmarksopenlevel=2,
    pdfstartview=FitH,
    pdfpagemode=UseOutlines,
    pdftitle={NimlothOS文档},
    pdfauthor={张竹和},
    pdfsubject={NimlothOS},
    pdfkeywords={操作系统, Rust, RISC-V},
    pdfcreator={LaTeX with hyperref},
    pdfproducer={XeLaTeX}
}

% 页面样式设置
\setlength{\headheight}{15pt} % 修复页眉高度警告
\pagestyle{fancy}
\fancyhf{} % 清除所有页眉页脚
\fancyhead[LE,RO]{\thepage} % 偶数页左侧，奇数页右侧显示页码
\fancyhead[RE]{\leftmark} % 偶数页右侧显示章标题
\fancyhead[LO]{\rightmark} % 奇数页左侧显示节标题
\renewcommand{\headrulewidth}{0.4pt} % 页眉线宽度

% 重新定义plain样式（用于章节首页）
\fancypagestyle{plain}{
    \fancyhf{}
    \fancyfoot[C]{\thepage}
    \renewcommand{\headrulewidth}{0pt}
}

% 文档信息
\title{NimlothOS文档}
\author{张竹和}
\date{\today}

\begin{document}

% 封面
\maketitle
\thispagestyle{empty} % 封面不显示页码

% 前言
\newpage
\pagenumbering{roman}
\setcounter{page}{1}
\input{chapters/preface}

% 目录
\newpage
\tableofcontents

% 正文开始，重新设置页码
\newpage
\pagenumbering{arabic}
\setcounter{page}{1}

% 第一章：系统概述
\include{chapters/ch01-system-overview}

% 第二章：系统启动与初始化
\include{chapters/ch02-boot-initialization}

% 第三章：内存管理系统
\include{chapters/ch03-memory-management}

% 第四章：任务管理与调度（任务、进程以及进程间通信、后面可能再加线程）
\include{chapters/ch04-process-scheduling}

% 第五章：中断与异常处理（特权级切换机制、中断处理机制、函数调用机制）
\include{chapters/ch05-interrupt-exception}

% 第六章：系统调用接口（罗列即可）
\include{chapters/ch06-syscall-interface}

% 第七章：文件系统
\include{chapters/ch07-filesystem}

% 第八章：设备驱动程序
% \include{chapters/ch08-device-drivers}

% 第九章：同步与互斥（信号量、进程间同步、等待队列、死锁处理等，如果有多核还需要多核同步）
% \include{chapters/ch09-synchronization}

% 第十章：用户程序与测试
\include{chapters/ch08-user-programs}

% 附录
\appendix
\include{chapters/appendix-a-environment}
\include{chapters/appendix-b-references}

\end{document}